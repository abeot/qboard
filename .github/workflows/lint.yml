name: Lint

on:
  push:
    branches: [master, main]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [master, main]

jobs:
  run-linters:
    name: Run linters
    runs-on: ubuntu-latest

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v1
        with:
          node-version: 12

      - name: Install Node.js dependencies
        run: npm ci

      - name: Run linters
        uses: wearerequired/lint-action@v1.6.0
        with:
          github_token: ${{ secrets.github_token }}
          auto_fix: true
          # Enable linters
          eslint: true
          # Override their command, which is defined at
          # https://github.com/wearerequired/lint-action/blob/cb48f596b88daacd6edbafe8939d9178cb789cb8/src/linters/eslint.js#L49
          # The "#" blocks their command fragment from running
          # We still use them because they implemented the library to annotate the source code with the eslint output
          #
          # They use the prefix twice: once at
          # https://github.com/wearerequired/lint-action/blob/cb48f596b88daacd6edbafe8939d9178cb789cb8/src/linters/eslint.js#L29
          # to check that eslint exists, and then once at
          # https://github.com/wearerequired/lint-action/blob/cb48f596b88daacd6edbafe8939d9178cb789cb8/src/linters/eslint.js#L49
          # when actually running eslint.
          # The first time (then), I want to clone exactly what they do;
          # otherwise if there are any eslint warnings or errors it will error out then and there.
          # The next time (else), I want to run my own eslint command,
          # but output to json so that the library can read it to annotate the source
          #
          # We must also prepend eslint itself with their default prefix "npx --no-install"
          # https://github.com/wearerequired/lint-action/blob/cb48f596b88daacd6edbafe8939d9178cb789cb8/src/utils/npm/get-npm-bin-command.js#L10
          eslint_command_prefix: >-
            if [ -z "$hasCheckedEslint" ];
              then
                npx --no-install eslint -v &&
                hasCheckedEslint=1;
              else
                npx --no-install eslint src/**/*.{js,ts,jsx,tsx} --fix --no-color --format json;
            fi
            #
            ^ the above "#" creates an end-of-line comment which blocks anything afterwards,
            including the library's commands
          prettier: true
          prettier_extensions: html,json,md,vue,yaml,yml # Only run on extensions not part of ESLint config
          stylelint: true
          stylelint_extensions: css,scss,sass
